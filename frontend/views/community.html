<div class="community-detail-container">
    <!-- Loading spinner -->
    <div style="text-align:center;padding:60px;">
        <div class="spinner-border text-danger" role="status">
            <span class="sr-only">Loading community...</span>
        </div>
    </div>
</div>

<script>
function loadCommunityDetail() {
    const communityId = sessionStorage.getItem('currentCommunityId');
    
    if (!communityId) {
        toastr.error("Community ID is missing");
        window.location.hash = "#explore-communities";
        return;
    }
    
    const currentUser = Utils.parseJwt(localStorage.getItem("user_token"));
    const currentUserId = currentUser.user.UserID;
    
    // Load community details
    CommunityService.loadCommunity(communityId, function(community) {
        if (!community) {
            toastr.error("Community not found");
            window.location.hash = "#explore-communities";
            return;
        }
        
        // Render community header
        renderCommunityHeader(community, currentUserId);
        
        // Load community posts
        CommunityPostService.loadCommunityPosts(communityId, function(posts) {
            CommunityPostService.renderCommunityPosts(posts, currentUserId, communityId);
        });
    });
}

function renderCommunityHeader(community, currentUserId) {
    const currentUser = Utils.parseJwt(localStorage.getItem("user_token"));
    const isAdmin = currentUser && currentUser.user.Role === 'admin';
    const isOwner = currentUserId == community.OwnerID;
    const canModify = isOwner || isAdmin;
    
    const headerHtml = `
    <div class="community front page card tall-card">
        <div class="community front page card-body">
            <div class="community-header">
                <h2 class="community-title">${PostService.escapeHtml(community.Name)}</h2>
                <p class="community-desc">${PostService.escapeHtml(community.Description || 'No description')}</p>
            </div>
            <div class="community-footer">
                <div class="members-box">Members: <span class="member-count" data-community-id="${community.CommunityID}">Loading...</span></div>
                <button class="subscribe-btn" data-community-id="${community.CommunityID}" data-subscribed="false">Subscribe</button>
                ${canModify ? `
                ${isOwner ? `<button class="btn btn-sm btn-outline-secondary ms-2" id="editCommunityBtn" data-community-id="${community.CommunityID}">Edit</button>` : ''}
                <button class="btn btn-sm btn-outline-danger ms-2" id="deleteCommunityBtn" data-community-id="${community.CommunityID}">Delete</button>
                ` : ''}
                <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#createCommunityPostModal">Create Post</button>
            </div>
        </div>
    </div>
    <div class="community-scope">
        <!-- Posts will be loaded here -->
    </div>
    `;
    
    $(".community-detail-container").html(headerHtml);
    
    // Load member count
    CommunityService.getSubscriberCount(community.CommunityID, function(count) {
        $(".member-count").text(count || 0);
    });
    
    // Check subscription status
    CommunityService.checkSubscription(community.CommunityID, function(isSubscribed) {
        const btn = $(".subscribe-btn");
        if (isSubscribed) {
            btn.text('Unsubscribe').data('subscribed', 'true');
        } else {
            btn.text('Subscribe').data('subscribed', 'false');
        }
    });
    
    // Attach handlers
    attachCommunityDetailHandlers(community.CommunityID);
}

function attachCommunityDetailHandlers(communityId) {
    // Subscribe/Unsubscribe
    $(".subscribe-btn").off('click').on('click', function(e) {
        e.preventDefault();
        const btn = $(this);
        const isSubscribed = btn.data('subscribed') === 'true';
        
        if (isSubscribed) {
            CommunityService.unsubscribe(communityId, function() {
                btn.text('Subscribe').data('subscribed', 'false');
                const countElement = $(".member-count");
                const currentCount = parseInt(countElement.text()) || 0;
                countElement.text(Math.max(0, currentCount - 1));
            });
        } else {
            CommunityService.subscribe(communityId, function() {
                btn.text('Unsubscribe').data('subscribed', 'true');
                const countElement = $(".member-count");
                const currentCount = parseInt(countElement.text()) || 0;
                countElement.text(currentCount + 1);
            });
        }
    });
    
    // Edit community (if owner)
    $("#editCommunityBtn").off('click').on('click', function(e) {
        e.preventDefault();
        const communityId = $(this).data('community-id');
        
        CommunityService.loadCommunity(communityId, function(community) {
            $("#editCommunityModal input[name='name']").val(community.Name);
            $("#editCommunityModal input[name='description']").val(community.Description);
            $("#editCommunityModal").data('community-id', communityId);
            $("#editCommunityModal").modal('show');
        });
    });
    
    // Delete community (if owner)
    $("#deleteCommunityBtn").off('click').on('click', function(e) {
        e.preventDefault();
        const communityId = $(this).data('community-id');
        
        CommunityService.deleteCommunity(communityId, function() {
            window.location.hash = "#explore-communities";
        });
    });
}

// Load community on page load
loadCommunityDetail();
</script>