<div id="post-detail-container">
    <!-- Loading spinner -->
    <div style="text-align:center;padding:60px;">
        <div class="spinner-border text-danger" role="status">
            <span class="sr-only">Loading post...</span>
        </div>
    </div>
</div>

<style>
.postpage-action.like-btn.liked svg path {
    fill: #dc3545;
}
.action.like-btn.liked svg path {
    fill: #dc3545;
}
</style>

<script>
// This function will be called every time the post page is loaded
function loadPostDetail() {
    // Get post ID from sessionStorage
    const postId = sessionStorage.getItem('currentPostId');
    
    if (!postId) {
        toastr.error("Post ID is missing");
        window.location.hash = "#dashboard";
        return;
    }
    
    const currentUser = Utils.parseJwt(localStorage.getItem("user_token"));
    const currentUserId = currentUser.user.UserID;
    
    // Load post details
    RestClient.get(`posts/${postId}/details`, function(post) {
        if (!post) {
            toastr.error("Post not found");
            window.location.hash = "#dashboard";
            return;
        }
        
        // Render post
        renderPostDetail(post, currentUserId);
        
        // Load comments
        CommentService.loadComments(postId, function(comments) {
            CommentService.renderComments(comments, currentUserId);
        });
        
        // Check if user liked this post
        LikeService.checkIfLiked(currentUserId, postId, function(hasLiked) {
            if (hasLiked) {
                $(".postpage-action.like-btn").addClass('liked');
            }
        });
        
    }, function(error) {
        toastr.error("Failed to load post");
        console.error(error);
    });
}

// Render post detail HTML
function renderPostDetail(post, currentUserId) {
    const postTime = PostService.formatTime(post.TimeOfPost || post.CreatedAt);
    const username = post.Username || 'Unknown';
    const likeCount = post.like_count || 0;
    const commentCount = post.comment_count || 0;
    const isOwner = currentUserId == post.UserID;
    
    const postHtml = `
    <div class="postpage-custom-card postpage-extended-card" data-post-id="${post.PostID}">
        <div class="postpage-card-body" style="padding:0;">
            <div class="postpage-avatar-header">
                <img src="assets/images/profile-icon.png" alt="Avatar" class="postpage-avatar-img">
                <div>
                    <span class="postpage-card-author">@${username}</span>
                    <small class="post-time" style="color:#9b9b9b;font-size:0.9rem;margin-left:8px;">Posted at ${postTime}</small>
                </div>
                ${isOwner ? `
                <div style="margin-left:auto;">
                    <button class="btn btn-sm btn-outline-secondary edit-post-detail-btn">Edit</button>
                    <button class="btn btn-sm btn-outline-danger delete-post-detail-btn">Delete</button>
                </div>
                ` : ''}
            </div>
            <h5 class="postpage-card-title">${PostService.escapeHtml(post.Title)}</h5>
            <p class="postpage-card-text">${PostService.escapeHtml(post.Content)}</p>
            <div class="postpage-card-footer">
                <div class="postpage-card-separator"></div>
                <button class="postpage-action like-btn" data-post-id="${post.PostID}" aria-label="Like">
                    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                        <path d="M12 21s-8.5-5.6-8.5-11.3A4.7 4.7 0 0 1 8.2 5a5.3 5.3 0 0 1 3.8 1.7A5.3 5.3 0 0 1 15.8 5a4.7 4.7 0 0 1 4.7 4.7C20.5 15.4 12 21 12 21z" fill="currentColor"/>
                    </svg>
                    <span class="like-count">${likeCount}</span>
                </button>
                <button class="postpage-action" aria-label="Comment">
                    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                        <path d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z" fill="currentColor"/>
                    </svg>
                    <span class="comment-count">${commentCount}</span>
                </button>
            </div>
            
            <!-- Comment Section -->
            <div class="postpage-comment-section postpage-comment-section-unified">
                <form class="postpage-comment-form" id="commentForm">
                    <textarea class="postpage-comment-textarea" name="content" placeholder="Write a comment" required></textarea>
                    <button type="submit" class="postpage-comment-btn">Post</button>
                </form>
                <div class="postpage-comments-list">
                    <!-- Comments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    `;
    
    $("#post-detail-container").html(postHtml);
    
    // Attach event handlers
    attachPostDetailHandlers(post.PostID, currentUserId);
}

// Attach event handlers for post detail page
function attachPostDetailHandlers(postId, currentUserId) {
    // Comment form submission
    $("#commentForm").off('submit').on("submit", function(e) {
        e.preventDefault();
        const content = $(this).find('textarea[name="content"]').val().trim();
        
        if (content) {
            CommentService.createComment(postId, content, function() {
                // Reload comments
                CommentService.loadComments(postId, function(comments) {
                    CommentService.renderComments(comments, currentUserId);
                });
                
                // Clear form
                $("#commentForm textarea").val('');
                
                // Update comment count
                const currentCount = parseInt($(".comment-count").text());
                $(".comment-count").text(currentCount + 1);
            });
        }
    });
    
    // Like button
    $(".like-btn").off('click').on('click', function(e) {
        e.preventDefault();
        const btn = $(this);
        
        LikeService.toggleLike(postId, function(isLiked) {
            // Update UI
            if (isLiked) {
                btn.addClass('liked');
                const currentCount = parseInt(btn.find('.like-count').text());
                btn.find('.like-count').text(currentCount + 1);
            } else {
                btn.removeClass('liked');
                const currentCount = parseInt(btn.find('.like-count').text());
                btn.find('.like-count').text(Math.max(0, currentCount - 1));
            }
        });
    });
    
    // Edit post
    $(".edit-post-detail-btn").off('click').on('click', function(e) {
        e.preventDefault();
        PostService.editPost(postId);
    });
    
    // Delete post
    $(".delete-post-detail-btn").off('click').on('click', function(e) {
        e.preventDefault();
        if (confirm("Are you sure you want to delete this post?")) {
            PostService.deletePost(postId);
            setTimeout(function() {
                window.location.hash = "#dashboard";
            }, 500);
        }
    });
}

// Call this function when the page loads
loadPostDetail();
</script>